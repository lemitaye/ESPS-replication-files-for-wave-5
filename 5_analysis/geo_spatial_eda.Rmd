---
title: "Geo-spatial variables in ESS5 - Exploratory Data Analysis"
author: "Lemi Daba (tayelemi@gmail.com)"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}

library(sp)
library(sf)
library(RColorBrewer)
library(colorspace)
library(haven)
library(tidyverse)

theme_set(theme_light())

```

```{r message=FALSE, warning=FALSE}

root <- "C:/Users/l.daba/SPIA Dropbox/SPIA General/5. OBJ.3 - Data collection/Country teams/Ethiopia/LSMS_W5"

# read data ----
hh_geo_w5 <- read_dta(
  file.path(root, "2_raw_data/data/HH/Pub_ETH_HouseholdGeovariables_Y5.dta")
  ) %>% 
  mutate_if(is.labelled, as_factor)

hh_geo_w4 <- read_dta(
  file.path(root, "supplemental/replication_files/2_raw_data/ESS4_2018-19/Data/ETH_HouseholdGeovariables_Y4.dta")
  ) %>% 
  mutate_if(is.labelled, as_factor)

ess5_weights_hh <- read_dta(file.path(root, "2_raw_data/data/HH/ESS5_weights_hh.dta"))

hh_cover_w4 <- read_dta(
  file.path(root, "supplemental/replication_files/2_raw_data/ESS4_2018-19/Data/sect_cover_hh_w4.dta")
) %>% 
  mutate_if(is.labelled, as_factor)

eth_regions <- st_read(
  dsn = "./gadm41_ETH_shp",
  layer = "gadm41_ETH_1",
  quiet = TRUE
)

```

```{r}

# wrangle ----

hh_geo_slctd_w5 <- hh_geo_w5 %>% 
  select(
    household_id, h_tot = h2021_tot, af_bio_12 = af_bio_12_x, wetQ_avg, af_bio_16 = af_bio_16_x, eviarea_avg,
    lat_mod = lat_dd_mod, lon_mod = lon_dd_mod, ssa_aez09
  ) %>% 
  left_join(
    ess5_weights_hh %>% 
      select(-interview__key) %>% 
      rename(locality = rururb),
    by = "household_id"
  ) %>% 
  mutate(year = "2021")

hh_geo_slctd_w4 <- hh_geo_w4 %>% 
  select(
    household_id, h_tot = h2018_tot, af_bio_12, wetQ_avg, af_bio_16, lat_mod, lon_mod, ssa_aez09
  ) %>% 
  left_join(
    hh_cover_w4 %>% 
      select(household_id, ea_id, locality = saq14, pw_w4, region = saq01),
    by = "household_id"
  ) %>% 
  mutate(year = "2018")

# Bind wave 4 and wave 5 together

hh_geo_slctd_bind <- bind_rows(hh_geo_slctd_w4, hh_geo_slctd_w5)


```

```{r}

# convert to sf:

# hh_geo_slctd_w5_sf <- hh_geo_slctd_w5 %>% 
#   filter(!is.na(lon_dd_mod), !is.na(lat_dd_mod)) %>% 
#   st_as_sf(coords = c("lon_dd_mod", "lat_dd_mod"), crs = st_crs(4326))
# 
# hh_geo_slctd_w4_sf <- hh_geo_slctd_w4 %>% 
#   filter(!is.na(lon_mod), !is.na(lat_mod)) %>% 
#   st_as_sf(coords = c("lon_mod", "lat_mod"), crs = st_crs(4326))

hh_geo_slctd_bind_sf <- hh_geo_slctd_bind %>% 
  filter(!is.na(lon_mod), !is.na(lat_mod)) %>% 
  st_as_sf(coords = c("lon_mod", "lat_mod"), crs = st_crs(4326))

```



```{r}

# Compute centroids of EAs:

# ea_sf_w5 <- hh_geo_slctd_w5_sf %>% 
#   group_by(ea_id) %>% 
#   summarise(geometry = st_union(geometry)) %>%
#   st_centroid() 
# 
# ea_sf_w4 <- hh_geo_slctd_w4_sf %>% 
#   group_by(ea_id) %>% 
#   summarise(geometry = st_union(geometry)) %>%
#   st_centroid() 

ea_sf_bind <- hh_geo_slctd_bind_sf %>% 
  group_by(ea_id) %>% 
  summarise(geometry = st_union(geometry)) %>%
  st_centroid() 


```



```{r}

# group by EA


# hh_geo_ea_w5 <- hh_geo_slctd_w5 %>% 
#   group_by(ea_id) %>% 
#   summarise(
#     across(
#       c(h2021_tot, af_bio_12_x, wetQ_avg, af_bio_16_x, eviarea_avg,
#         avg_precip, avg_wet), 
#       list(mean = mean, median = median)
#     ), 
#     across(c(region, rururb, ssa_aez09), first)
#   )
# 
# hh_geo_ea_w4 <- hh_geo_slctd_w4 %>% 
#   group_by(ea_id) %>% 
#   summarise(
#     across(
#       c(h2021_tot, af_bio_12_x, wetQ_avg, af_bio_16_x, eviarea_avg,
#         avg_precip, avg_wet), 
#       list(mean = mean, median = median)
#     ), 
#     across(c(region, rururb, ssa_aez09), first)
#   )

hh_geo_ea_bind <- hh_geo_slctd_bind %>% 
  group_by(year, ea_id) %>% 
  summarise(
    across(
      c(h_tot, af_bio_12, wetQ_avg, af_bio_16), 
      list(mean = mean, median = median)
    ), 
    across(c(region, locality, ssa_aez09), first),
    .groups = "drop"
  )

geo_ea_sf_w5 <- ea_sf_w5 %>% 
  left_join(hh_geo_ea_w5)

geo_ea_sf_w4 <- ea_sf_w4 %>% 
  left_join(hh_geo_ea_w4)

geo_ea_sf_bind <- ea_sf_bind %>% 
  left_join(hh_geo_ea_bind)


```

# Map by EA centroids

```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = h2021_tot_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "12-month total rainfall (mm) in 2021",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```



```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = avg_precip_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "12-month total rainfall (mm) in 2021",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```



```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = af_bio_12_x_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "Annual Precipitation (mm)",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```




```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = wetQ_avg_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "Average total rainfall in wettest quarter (mm)",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```



```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = af_bio_16_x_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "Precipitation of Wettest Quarter",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```

```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_w5, 
    aes(size = eviarea_avg_mean, color = rururb), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "Precipitation of Wettest Quarter",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```


```{r}

ggplot() +
  geom_sf(data = eth_regions, fill = NA) +
  geom_sf(
    data = geo_ea_sf_bind, 
    aes(size = af_bio_12_mean, color = locality), 
    alpha = .5
    ) +
  coord_sf() +
  labs(
    title = "Annual Precipitation (mm)",
    subtitle = "Mean at the EA level",
    color = "Locality",
    size = "Rainfall (mm)"
  )

```


## Comparison by region

```{r}

# ggplot() +
#   geom_sf(data = eth_regions) +
#   geom_sf(data = hh_geo_slctd_w5_sf, aes(size = h2021_tot), alpha = .5)

```

```{r}

hh_geo_slctd_w5 %>% 
  ggplot(aes(h2021_tot)) +
  geom_histogram() 

```

```{r}

hh_geo_slctd_w5 %>% 
  ggplot(aes(h2021_tot)) +
  geom_histogram() +
  facet_wrap(~ region, scales = "free", ncol = 3)

```

```{r}

hh_geo_slctd_w5 %>% 
  mutate(region = fct_reorder(region, af_bio_12_x)) %>% 
  ggplot(aes(af_bio_12_x, region, fill = rururb)) +
  geom_boxplot() +
  facet_wrap(~rururb, scales = "free_x") +
  theme(legend.position = "none") +
  labs(
    title = "Annual Precipitation (mm) by region",
    fill = "Locality",
    x = "Annual Precipitation (mm)",
    y = ""
  )

```

```{r}

hh_geo_slctd_w5 %>% 
  ggplot(aes(h2021_tot, af_bio_12_x, color = region)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(
    x = "12-month total rainfall (mm) in 2021",
    y = "Annual Precipitation (mm)",
    subtitle = "Household level",
    color = "Region"
  )

```


```{r}

geo_ea_sf_w5 %>% 
  ggplot(aes(h2021_tot_mean, af_bio_12_x_mean, color = region)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(
    x = "12-month total rainfall (mm) in 2021",
    y = "Annual Precipitation (mm)",
    subtitle = "EA level",
    color = "Region"
  )

```

```{r}

hh_geo_slctd_w5 %>% 
  ggplot(aes(h2021_tot, af_bio_12_x, color = region)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(
    x = "12-month total rainfall (mm) in 2021",
    y = "Annual Precipitation (mm)",
    subtitle = "Household level",
    color = "Region"
  )

```


```{r}

hh_geo_slctd_w5 %>% 
  count(region, ssa_aez09) %>% 
  group_by(region) %>% 
  mutate(pct_aez = n / sum(n)) %>% 
  ggplot(aes(pct_aez, ssa_aez09)) +
  geom_col() +
  facet_wrap(~ region)

```
























